<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼å…’åœ’æ”¶è²»æ”¶æ“š (å®Œç¾å­˜æª”çµ‚æ¥µç‰ˆ - é›™è¯åŠŸèƒ½ + å€‹åˆ¥å¾®èª¿)</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: #525659;
            height: 100vh;
            overflow: hidden;
        }

        /* --- å·¦å´æ§åˆ¶é¢æ¿ --- */
        .sidebar {
            width: 400px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            z-index: 10;
            overflow-y: auto;
        }

        .tabs-nav { display: flex; background: #1a252f; border-bottom: 1px solid #34495e; position: sticky; top: 0; z-index: 20; }
        .tab-btn {
            flex: 1; padding: 15px 5px; border: none; background: none;
            cursor: pointer; font-size: 14px; font-weight: bold; color: #95a5a6;
            transition: 0.3s; border-bottom: 4px solid transparent;
        }
        .tab-btn:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active { color: #fff; background-color: #2c3e50; border-bottom: 4px solid #27ae60; }

        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 15px; color: #ecf0f1; font-weight: bold; }
        input[type="text"], input[type="number"], textarea, select, input[type="date"] {
            width: 100%; padding: 10px; margin-top: 2px; box-sizing: border-box;
            border: 1px solid #95a5a6; border-radius: 4px; background: #fff;
            font-size: 16px; font-family: "Microsoft JhengHei", sans-serif;
        }
        textarea { resize: vertical; line-height: 1.5; }
        .fee-grid { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; gap: 10px; margin: 20px 20px; }
        .btn {
            flex: 1;
            background-color: #27ae60; color: white; border: none; padding: 12px;
            font-size: 16px; cursor: pointer; border-radius: 5px;
            font-weight: bold; box-shadow: 0 4px 0 #219150;
            text-align: center;
            margin-bottom: 10px; /* å¢åŠ æŒ‰éˆ•é–“è· */
        }
        .btn:hover { background-color: #2ecc71; }
        .btn-blue { background-color: #2980b9; box-shadow: 0 4px 0 #20638f; }
        .btn-blue:hover { background-color: #3498db; }
        .btn-orange { background-color: #e67e22; box-shadow: 0 4px 0 #a85a15; }
        .btn-orange:hover { background-color: #d35400; }
        .btn-purple { background-color: #8e44ad; box-shadow: 0 4px 0 #6c3483; } 
        .btn-purple:hover { background-color: #9b59b6; }
        .btn-sm { padding: 5px 10px; font-size: 13px; margin: 0; box-shadow: none; border: 1px solid rgba(0,0,0,0.2); }

        /* é è¦½åˆ‡æ› Radio */
        .preview-toggle {
            display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;
        }
        .preview-toggle label { display: flex; align-items: center; cursor: pointer; margin: 0; font-weight: normal; }
        .preview-toggle input { width: auto; margin-right: 5px; }

        /* å­¸ç”Ÿåˆ—è¡¨æ§åˆ¶å€ */
        .student-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #f1c40f;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .student-header { display: flex; justify-content: space-between; align-items: center; }
        .student-name { font-weight: bold; font-size: 1.1em; color: #f1c40f; }
        .student-controls { display: flex; gap: 5px; align-items: center; }
        .student-controls select, .student-controls input { font-size: 14px; padding: 5px; }
        .has-custom-fee { color: #2ecc71; font-weight: bold; font-size: 12px; margin-left: 5px; }

        /* --- å½ˆå‡ºè¦–çª— (Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #2c3e50; padding: 20px; border-radius: 8px;
            width: 360px; max-height: 90vh; overflow-y: auto;
            color: white; border: 2px solid #f1c40f; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; color: #f1c40f; }
        .modal-row { display: flex; align-items: center; margin-bottom: 8px; justify-content: space-between; }
        .modal-row label { font-size: 14px; margin: 0; width: 40%; }
        .modal-row input { width: 55%; padding: 5px; font-size: 14px; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; }

        /* --- å³å´é è¦½å€ --- */
        .preview-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* =========================================
           â˜… æ”¶æ“šæ¨£å¼ (å¤§å­—æ¸…æ™°ç‰ˆ) â˜…
           ========================================= */
        .receipt-container {
            width: 270mm; 
            background: white;
            margin-bottom: 40px; 
            padding: 5mm; 
            font-family: "æ¨™æ¥·é«”", "DFKai-SB", sans-serif;
            box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        table.receipt-table {
            width: 100%;
            border-collapse: collapse;
            border: 3px solid black;
            color: black;
            font-family: "æ¨™æ¥·é«”", "DFKai-SB", sans-serif;
            table-layout: fixed; 
        }

        table.receipt-table th, 
        table.receipt-table td {
            border: 1px solid black;
            padding: 1px 4px; 
            vertical-align: middle;
            font-size: 20px; 
            font-weight: 600; 
            line-height: 1.1; 
            height: 26px; 
        }

        .title-row { 
            text-align: center; 
            font-size: 32px !important; 
            font-weight: 800 !important; 
            padding: 5px !important;
            border-bottom: 3px solid black !important; 
        }
        
        .header-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-weight: bold; 
            font-size: 20px; 
            padding: 4px 2px; 
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        
        .col-item { width: 14%; }
        .col-period { width: 9%; }
        .col-amount { width: 16%; }
        .col-desc { width: 36%; } 
        .col-note { width: 25%; }

        .desc-text { font-size: 16px !important; line-height: 1.2; font-weight: 600; }
        .small-note { 
            font-size: 18px !important; 
            font-weight: 800 !important; 
            line-height: 1.05; 
        }

        .col-amount, .text-right {
            font-family: Arial, "æ¨™æ¥·é«”", sans-serif; 
            font-weight: 800 !important; 
            font-size: 21px !important; 
        }

        .total-row {
            font-size: 24px !important; 
            font-weight: 900 !important;
            padding: 6px !important;
            background-color: #f0f0f0; 
        }

        .footer-info {
            margin-top: 5px; 
            padding: 0 10px; 
            font-weight: bold; 
            font-size: 18px; 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            align-items: center;
        }

        /* =========================================
           â˜… åˆ—å°å°ˆç”¨è¨­å®š â˜…
           ========================================= */
        @media print {
            @page {
                size: A4 landscape;
                margin: 3mm; 
            }
            body { background: white; display: block; }
            .sidebar { display: none; }
            .preview-area { padding: 0; display: block; background: white; }
            .receipt-container {
                width: 100%; height: 100%; max-width: none; margin: 0; box-shadow: none; padding: 2mm; border: none;
                page-break-after: always; break-after: page;
            }
            table.receipt-table { border: 3px solid black !important; }
            .receipt-container:last-child { page-break-after: auto; break-after: auto; }
            .modal-overlay { display: none !important; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab('tab-basic')">1.åŸºæœ¬</button>
            <button class="tab-btn" onclick="switchTab('tab-fees')">2.è²»ç”¨</button>
            <button class="tab-btn" onclick="switchTab('tab-students')">3.å­¸ç”Ÿ</button>
            <button class="tab-btn" onclick="switchTab('tab-preview')">4.æ”¶æ“šé è¦½</button>
        </div>

        <div id="tab-basic" class="tab-content active">
            <div class="form-group">
                <label>å¹¼å…’åœ’åç¨±</label>
                <input type="text" id="schoolName" value="æ–°åŒ—å¸‚ç§ç«‹ä¸Šè¾²å¹¼å…’åœ’" oninput="generate()">
            </div>
            <div class="form-group">
                <label>å­¸æœŸèªªæ˜</label>
                <textarea id="termDesc" rows="3" oninput="generate()">ç¹³äº¤114å­¸å¹´åº¦ç¬¬1å­¸æœŸå„é …è²»ç”¨--æœ¬å­¸æœŸæœ¬åœ’ä¹‹æ•™ä¿æœå‹™èµ·è¿„æ—¥ï¼šã€114å¹´08æœˆ01æ—¥è‡³115å¹´01æœˆ31æ—¥ï¼Œ1å­¸æœŸä»¥6å€‹æœˆè¨ˆç®—ã€‘</textarea>
            </div>
            <div class="form-group">
                <label>æ³•è¦å‚™è¨»</label>
                <input type="text" id="legalNote" value="æœ¬åœ’æ”¶é€€è²»åŸºæº–ä¾æ“šã€Œæ–°åŒ—å¸‚æ•™ä¿æœå‹™æ©Ÿæ§‹æ”¶é€€è²»è¾¦æ³•ã€è¾¦ç†ã€‚" oninput="generate()">
            </div>
            <div class="form-group">
                <label>åˆè¨ˆæ¨™é¡Œ</label>
                <input type="text" id="totalLabel" value="å…«æœˆç¹³è²»åˆè¨ˆ" oninput="generate()">
            </div>
            
            <hr style="border: 1px solid #555;">
            
            <div class="form-group">
                <label>è³‡æ–™å­˜å– (å«å€‹åˆ¥è¨­å®š)</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn btn-blue" onclick="saveData()" style="margin:0; font-size:14px;">ğŸ’¾ å­˜æª”</button>
                    <button class="btn btn-orange" onclick="document.getElementById('fileInput').click()" style="margin:0; font-size:14px;">ğŸ“‚ è®€æª”</button>
                </div>
                <input type="file" id="fileInput" style="display:none;" onchange="loadData(this)">
            </div>
        </div>

        <div id="tab-fees" class="tab-content">
            <div style="color:#aaa; font-size:13px; margin-bottom:10px;">â˜… æ­¤è™•ç‚ºã€Œå…¨åŸŸé è¨­é‡‘é¡ã€ï¼Œè‹¥å­¸ç”Ÿç„¡ç‰¹åˆ¥è¨­å®šå°‡æ¡ç”¨æ­¤é‡‘é¡ã€‚</div>
            <div class="fee-grid">
                <div class="form-group"><label>å­¸è²» (ä¸€å­¸æœŸ)</label><input type="number" id="fee_tuition" value="18000" oninput="generate()"></div>
                <div class="form-group"><label>é›œè²» (ä¸€å€‹æœˆ)</label><input type="number" id="fee_misc" value="5000" oninput="generate()"></div>
                <div class="form-group"><label>ææ–™è²» (ä¸€å­¸æœŸ)</label><input type="number" id="fee_material" value="5000" oninput="generate()"></div>
                <div class="form-group"><label>æ´»å‹•è²» (ä¸€å€‹æœˆ)</label><input type="number" id="fee_activity" value="500" oninput="generate()"></div>
                <div class="form-group"><label>åˆé¤è²» (ä¸€å€‹æœˆ)</label><input type="number" id="fee_lunch" value="1500" oninput="generate()"></div>
                <div class="form-group"><label>é»å¿ƒè²» (ä¸€å€‹æœˆ)</label><input type="number" id="fee_snack" value="1000" oninput="generate()"></div>
            </div>
            <div class="fee-grid">
                <div class="form-group"><label>äº¤é€šè²»-å–®è¶Ÿ</label><input type="number" id="fee_trans_single" value="500" oninput="generate()"></div>
                <div class="form-group"><label>äº¤é€šè²»-é›™è¶Ÿ</label><input type="number" id="fee_trans_round" value="1000" oninput="generate()"></div>
            </div>
            <div class="fee-grid">
                <div class="form-group"><label>å»¶é•·ç…§é¡§</label><input type="number" id="fee_extended" value="0" oninput="generate()"></div>
                <div class="form-group"><label>ä¿éšªè²»</label><input type="number" id="fee_insurance" value="233" oninput="generate()"></div>
                <div class="form-group"><label>å…¶å®ƒ</label><input type="number" id="fee_other" value="0" oninput="generate()"></div>
            </div>
        </div>

        <div id="tab-students" class="tab-content">
            <div class="form-group">
                <label>ç­åˆ¥ (å…¨åŸŸé è¨­)</label>
                <input type="text" id="className" value="å¤§ä¸€ç­" oninput="updateGlobalClassName(this.value)">
                <div style="color:#aaa; font-size:12px; margin-top:5px;">* ä¿®æ”¹æ­¤è™•å°‡åŒæ­¥æ›´æ–°æ‰€æœ‰æœªå€‹åˆ¥è¨­å®šç­ç´šçš„å­¸ç”Ÿ</div>
            </div>
            
            <div class="form-group">
                <label>å¿«é€Ÿæ–°å¢å­¸ç”Ÿ (ä¸€è¡Œä¸€ä½ï¼Œè²¼ä¸Šå¾ŒæŒ‰æ›´æ–°)</label>
                <textarea id="studentRawInput" rows="5" placeholder="ä¾‹å¦‚ï¼š
ç«¥å”¯ç¿
æ—å°ç¾"></textarea>
                <button class="btn btn-blue" onclick="parseStudents()" style="width:100%; margin: 10px 0;">â¬‡ï¸ æ›´æ–°å­¸ç”Ÿåˆ—è¡¨</button>
            </div>

            <div class="fee-grid">
                <label>ç¹³è²»æ—¥æœŸè¨­å®š</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="dateStart" title="é–‹å§‹æ—¥æœŸ">
                    <span style="align-self:center;">~</span>
                    <input type="date" id="dateEnd" title="çµæŸæ—¥æœŸ">
                </div>
                <button class="btn btn-orange" onclick="randomizeDates()" style="width:100%; margin: 10px 0; font-size:14px;">ğŸ² éš¨æ©Ÿåˆ†é…æ—¥æœŸ (è‡ªå‹•é¿é–‹é€±æœ«ä¸”ä¾åº)</button>
            </div>

            <div class="fee-grid">
                <label>äº¤é€šè»Šéš¨æ©Ÿåˆ†é…</label>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label style="font-size:12px; color:#ddd;">å–®è¶Ÿäººæ•¸</label>
                        <input type="number" id="rand_single_count" value="0" min="0" placeholder="0">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:12px; color:#ddd;">é›™è¶Ÿäººæ•¸</label>
                        <input type="number" id="rand_round_count" value="0" min="0" placeholder="0">
                    </div>
                </div>
                <button class="btn btn-orange" onclick="randomizeTrans()" style="width:100%; margin: 10px 0; font-size:14px;">ğŸ² éš¨æ©Ÿåˆ†é…äº¤é€šè»Š</button>
            </div>
            <label>å€‹åˆ¥è¨­å®š (ç­ç´š/äº¤é€š/æ—¥æœŸ/é‡‘é¡)</label>
            <div id="studentListContainer"></div>
        </div>

        <div id="tab-preview" class="tab-content">
            <div class="form-group">
                <label>é è¦½é¡¯ç¤ºæ¨¡å¼</label>
                <div class="preview-toggle">
                    <label>
                        <input type="radio" name="viewMode" value="school" checked onchange="updateViewMode(this.value)"> ç¬¬ä¸€è¯ (å¹¼å…’åœ’)
                    </label>
                    <label>
                        <input type="radio" name="viewMode" value="payer" onchange="updateViewMode(this.value)"> ç¬¬äºŒè¯ (ç¹³è²»äºº)
                    </label>
                </div>
                <p style="color:#aaa; font-size:13px; margin-top:5px;">
                    * æ­¤è™•åˆ‡æ›åƒ…å½±éŸ¿å³å´é è¦½ç•«é¢ã€‚<br>
                    * è‹¥è¦åˆ—å°å®Œæ•´æ”¶æ“šï¼ˆå…©è¯éƒ½æœ‰ï¼‰ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œé›™è¯åˆä½µåˆ—å°ã€æŒ‰éˆ•ã€‚
                </p>
            </div>
        </div>

        <div style="padding: 20px;">
            <button class="btn" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°ç›®å‰é è¦½ (å–®ä¸€ç‰ˆæœ¬)</button>
            <button class="btn btn-blue" onclick="printCombined()">ğŸ–¨ï¸ é›™è¯åˆä½µåˆ—å° (å­¸æ ¡+å®¶é•·)</button>
        </div>
    </div>

    <div id="customFeeModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                ğŸ’° å€‹åˆ¥è²»ç”¨å¾®èª¿ï¼š<span id="modalStudentName"></span>
            </div>
            <div style="font-size:13px; color:#aaa; margin-bottom:15px;">
                èªªæ˜ï¼šè¼¸å…¥æ•¸å­—å³å¯è¦†è“‹å…¨åŸŸè¨­å®šã€‚è‹¥æ¬„ä½ç•™ç©ºï¼Œå‰‡è‡ªå‹•ä½¿ç”¨é è¨­å€¼ã€‚
            </div>
            <div id="modalInputs">
                </div>
            <div class="modal-footer">
                <button class="btn btn-blue" onclick="saveCustomFees()">âœ… ç¢ºå®šå„²å­˜</button>
                <button class="btn btn-orange" onclick="closeModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="preview-area" id="outputArea"></div>

    <script>
        // å­¸ç”Ÿè³‡æ–™çµæ§‹ï¼š { name: "ç«¥å”¯ç¿", trans: "none", date: "114å¹´08æœˆ08æ—¥", className: "å¤§ä¸€ç­", customFees: {} }
        let studentsData = [];
        let currentViewMode = 'school'; 
        let editingStudentIndex = -1; // ç”¨æ–¼è¨˜éŒ„ç›®å‰æ­£åœ¨ç·¨è¼¯å“ªä½å­¸ç”Ÿçš„è²»ç”¨

        // è²»ç”¨ ID å°ç…§è¡¨ (ç”¨æ–¼ç”Ÿæˆ Modal)
        const feeFields = [
            { id: 'fee_tuition', label: 'å­¸è²»' },
            { id: 'fee_misc', label: 'é›œè²»' },
            { id: 'fee_material', label: 'ææ–™è²»' },
            { id: 'fee_activity', label: 'æ´»å‹•è²»' },
            { id: 'fee_lunch', label: 'åˆé¤è²»' },
            { id: 'fee_snack', label: 'é»å¿ƒè²»' },
            { id: 'fee_trans_single', label: 'äº¤é€šè²»(å–®è¶Ÿ)' },
            { id: 'fee_trans_round', label: 'äº¤é€šè²»(é›™è¶Ÿ)' },
            { id: 'fee_extended', label: 'å»¶é•·ç…§é¡§' },
            { id: 'fee_insurance', label: 'ä¿éšªè²»' },
            { id: 'fee_other', label: 'å…¶å®ƒ' }
        ];

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const btns = document.querySelectorAll('.tab-btn');
            if(tabId === 'tab-basic') btns[0].classList.add('active');
            if(tabId === 'tab-fees') btns[1].classList.add('active');
            if(tabId === 'tab-students') btns[2].classList.add('active');
            if(tabId === 'tab-preview') btns[3].classList.add('active');
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            const today = new Date();
            document.getElementById('dateStart').valueAsDate = today;
            document.getElementById('dateEnd').valueAsDate = today;
            parseStudents(); 
        };

        function formatMoney(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

        function updateViewMode(mode) {
            currentViewMode = mode;
            generate();
        }
        
        // ç•¶å…¨åŸŸç­ç´šè®Šå‹•æ™‚ï¼Œæ›´æ–°æ‰€æœ‰å­¸ç”Ÿ (æ–¹ä¾¿æ“ä½œ)
        function updateGlobalClassName(val) {
            studentsData.forEach(s => {
                s.className = val;
            });
            renderStudentList();
            generate();
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°å­¸ç”Ÿåå–® ---
        function parseStudents() {
            const raw = document.getElementById('studentRawInput').value;
            const lines = raw.split('\n');
            const newStudents = [];
            const defaultDate = "114å¹´08æœˆ08æ—¥";
            const defaultClass = document.getElementById('className').value;

            lines.forEach(line => {
                const name = line.trim();
                if (name) {
                    const existing = studentsData.find(s => s.name === name);
                    if (existing) {
                        newStudents.push(existing);
                    } else {
                        newStudents.push({
                            name: name,
                            trans: "none", 
                            date: defaultDate,
                            className: defaultClass, // é è¨­ä½¿ç”¨ç•¶å‰å…¨åŸŸç­ç´š
                            customFees: {} // åˆå§‹åŒ–è‡ªè¨‚è²»ç”¨
                        });
                    }
                }
            });
            studentsData = newStudents;
            renderStudentList();
            generate();
        }

        // --- æ¸²æŸ“å­¸ç”Ÿå€‹åˆ¥è¨­å®šå€å¡Š ---
        function renderStudentList() {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '';

            studentsData.forEach((s, index) => {
                const hasCustom = s.customFees && Object.keys(s.customFees).length > 0;
                const customIndicator = hasCustom ? '<span class="has-custom-fee">(å·²å¾®èª¿)</span>' : '';
                const currentClass = s.className || document.getElementById('className').value;

                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <div class="student-header">
                        <span class="student-name">${index+1}. ${s.name} ${customIndicator}</span>
                        <button class="btn btn-purple btn-sm" onclick="openCustomFeeModal(${index})">ğŸ’° è²»ç”¨å¾®èª¿</button>
                    </div>
                    <div class="student-controls">
                        <input type="text" value="${currentClass}" oninput="updateStudent(${index}, 'className', this.value)" style="flex:1;" placeholder="ç­ç´š">
                        <select onchange="updateStudent(${index}, 'trans', this.value)" style="flex:1;">
                            <option value="none" ${s.trans==='none'?'selected':''}>ç„¡äº¤é€šè»Š</option>
                            <option value="single" ${s.trans==='single'?'selected':''}>å–®è¶Ÿ</option>
                            <option value="round" ${s.trans==='round'?'selected':''}>é›™è¶Ÿ</option>
                        </select>
                        <input type="text" value="${s.date}" oninput="updateStudent(${index}, 'date', this.value)" style="flex:1;">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStudent(index, field, value) {
            studentsData[index][field] = value;
            generate();
        }

        // --- â˜…â˜…â˜… å€‹åˆ¥è²»ç”¨å¾®èª¿åŠŸèƒ½ â˜…â˜…â˜… ---
        function openCustomFeeModal(index) {
            editingStudentIndex = index;
            const student = studentsData[index];
            document.getElementById('modalStudentName').textContent = student.name;
            
            const container = document.getElementById('modalInputs');
            container.innerHTML = '';

            feeFields.forEach(field => {
                const globalVal = document.getElementById(field.id).value;
                // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªè¨‚å€¼
                const currentVal = (student.customFees && student.customFees[field.id] !== undefined) ? student.customFees[field.id] : '';
                
                const div = document.createElement('div');
                div.className = 'modal-row';
                div.innerHTML = `
                    <label>${field.label}</label>
                    <input type="number" id="modal_${field.id}" placeholder="é è¨­: ${globalVal}" value="${currentVal}">
                `;
                container.appendChild(div);
            });

            document.getElementById('customFeeModal').style.display = 'flex';
        }

        function saveCustomFees() {
            if (editingStudentIndex === -1) return;
            const student = studentsData[editingStudentIndex];
            
            if (!student.customFees) student.customFees = {};

            feeFields.forEach(field => {
                const inputVal = document.getElementById(`modal_${field.id}`).value;
                if (inputVal === '') {
                    // å¦‚æœæ¸…ç©ºï¼Œåˆªé™¤è©² keyï¼Œå›å¾©ä½¿ç”¨é è¨­å€¼
                    delete student.customFees[field.id];
                } else {
                    student.customFees[field.id] = Number(inputVal);
                }
            });

            closeModal();
            renderStudentList(); // æ›´æ–°åˆ—è¡¨é¡¯ç¤º (é¡¯ç¤º"å·²å¾®èª¿")
            generate(); // æ›´æ–°é è¦½
        }

        function closeModal() {
            document.getElementById('customFeeModal').style.display = 'none';
            editingStudentIndex = -1;
        }

        // --- Helper: å–å¾—æœ€çµ‚è²»ç”¨ (å„ªå…ˆè®€å–è‡ªè¨‚ï¼Œå¦å‰‡è®€å–å…¨åŸŸ) ---
        function getFee(student, feeId) {
            // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦æœ‰è©²é …ç›®çš„è‡ªè¨‚è²»ç”¨
            if (student.customFees && student.customFees[feeId] !== undefined && student.customFees[feeId] !== null) {
                return Number(student.customFees[feeId]);
            }
            // å¦å‰‡å›å‚³å…¨åŸŸè¨­å®š
            return Number(document.getElementById(feeId).value) || 0;
        }


        // --- æ—¥æœŸéš¨æ©Ÿåˆ†é…é‚è¼¯ (ä¿®æ”¹ï¼šæŒ‰é †åºåˆ†é…) ---
        function randomizeDates() {
            const startStr = document.getElementById('dateStart').value;
            const endStr = document.getElementById('dateEnd').value;
            
            if (!startStr || !endStr) { alert("è«‹å…ˆé¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ"); return; }
            const start = new Date(startStr);
            const end = new Date(endStr);
            if (start > end) { alert("é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ"); return; }

            // 1. ç”¢ç”Ÿèˆ‡å­¸ç”Ÿæ•¸é‡ç›¸åŒçš„éš¨æ©Ÿæ—¥æœŸæ±  (ç¢ºä¿é¿é–‹é€±æœ«)
            let datePool = [];
            const studentCount = studentsData.length;
            const timeDiff = end.getTime() - start.getTime();

            for (let i = 0; i < studentCount; i++) {
                let validDate = false;
                let randomDateObj;
                let attempt = 0;
                
                while (!validDate && attempt < 100) {
                    const randomTime = Math.random() * (timeDiff + 86400000); // +1å¤©ç¢ºä¿åŒ…å«çµæŸæ—¥ç•¶å¤©
                    // è‹¥è¶…éçµæŸæ—¥æœŸæ™‚é–“é»ï¼Œä¿®æ­£å›ä¾† (é¿å…è¶…éæœ€å¾Œä¸€å¤©å¤ªå¤š)
                    let checkTime = start.getTime() + randomTime;
                    if(checkTime > end.getTime() + 86400000 - 1) checkTime = end.getTime();
                    
                    randomDateObj = new Date(checkTime);
                    const day = randomDateObj.getDay();
                    if (day !== 0 && day !== 6) {
                        validDate = true;
                    }
                    attempt++;
                }
                datePool.push(randomDateObj);
            }

            // 2. æ’åºæ—¥æœŸ (æ™‚é–“å…ˆåˆ°å¾Œ)
            datePool.sort((a, b) => a - b);

            // 3. ä¾åºåˆ†é…çµ¦å­¸ç”Ÿ
            studentsData.forEach((s, index) => {
                if (datePool[index]) {
                    const d = datePool[index];
                    const rocYear = d.getFullYear() - 1911;
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const date = d.getDate().toString().padStart(2, '0');
                    s.date = `${rocYear}å¹´${month}æœˆ${date}æ—¥`;
                }
            });

            renderStudentList();
            generate();
            alert("æ—¥æœŸå·²ä¾åºéš¨æ©Ÿåˆ†é…å®Œç•¢ï¼");
        }

        // --- äº¤é€šè»Šéš¨æ©Ÿåˆ†é…é‚è¼¯ ---
        function randomizeTrans() {
            const singleCount = parseInt(document.getElementById('rand_single_count').value) || 0;
            const roundCount = parseInt(document.getElementById('rand_round_count').value) || 0;
            
            if (singleCount < 0 || roundCount < 0) { alert("äººæ•¸ä¸èƒ½ç‚ºè² æ•¸"); return; }
            if (singleCount + roundCount > studentsData.length) {
                alert("äººæ•¸è¶…éç›®å‰å­¸ç”Ÿç¸½æ•¸ï¼");
                return;
            }

            studentsData.forEach(s => s.trans = 'none');
            const indices = Array.from(studentsData.keys()); 
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            for (let i = 0; i < singleCount; i++) studentsData[indices[i]].trans = 'single';
            for (let i = 0; i < roundCount; i++) studentsData[indices[singleCount + i]].trans = 'round';

            renderStudentList();
            generate();
            alert("äº¤é€šè»Šåˆ†é…å®Œæˆï¼");
        }

        // --- å­˜æª”èˆ‡è®€æª” ---
        function saveData() {
            const termDesc = document.getElementById('termDesc').value;
            const className = document.getElementById('className').value;
            const match = termDesc.match(/(\d+)å­¸å¹´åº¦ç¬¬(\d+)å­¸æœŸ/);
            let filename = "æ”¶æ“šè³‡æ–™å‚™ä»½.json";
            if (match && className) filename = `${match[1]}0${match[2]}${className}.json`; 

            const dataToSave = {
                students: studentsData,
                settings: {
                    schoolName: document.getElementById('schoolName').value,
                    termDesc: termDesc,
                    legalNote: document.getElementById('legalNote').value,
                    totalLabel: document.getElementById('totalLabel').value,
                    className: className,
                    dateStart: document.getElementById('dateStart').value,
                    dateEnd: document.getElementById('dateEnd').value,
                    fees: {
                        tuition: document.getElementById('fee_tuition').value,
                        misc: document.getElementById('fee_misc').value,
                        material: document.getElementById('fee_material').value,
                        activity: document.getElementById('fee_activity').value,
                        lunch: document.getElementById('fee_lunch').value,
                        snack: document.getElementById('fee_snack').value,
                        trans_single: document.getElementById('fee_trans_single').value,
                        trans_round: document.getElementById('fee_trans_round').value,
                        extended: document.getElementById('fee_extended').value,
                        insurance: document.getElementById('fee_insurance').value,
                        other: document.getElementById('fee_other').value
                    }
                }
            };

            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('schoolName').value = data.settings.schoolName;
                    document.getElementById('termDesc').value = data.settings.termDesc;
                    document.getElementById('legalNote').value = data.settings.legalNote;
                    document.getElementById('totalLabel').value = data.settings.totalLabel;
                    document.getElementById('className').value = data.settings.className;
                    if(data.settings.dateStart) document.getElementById('dateStart').value = data.settings.dateStart;
                    if(data.settings.dateEnd) document.getElementById('dateEnd').value = data.settings.dateEnd;
                    
                    document.getElementById('fee_tuition').value = data.settings.fees.tuition;
                    document.getElementById('fee_misc').value = data.settings.fees.misc;
                    document.getElementById('fee_material').value = data.settings.fees.material;
                    document.getElementById('fee_activity').value = data.settings.fees.activity;
                    document.getElementById('fee_lunch').value = data.settings.fees.lunch;
                    document.getElementById('fee_snack').value = data.settings.fees.snack;
                    document.getElementById('fee_trans_single').value = data.settings.fees.trans_single;
                    document.getElementById('fee_trans_round').value = data.settings.fees.trans_round;
                    document.getElementById('fee_extended').value = data.settings.fees.extended;
                    document.getElementById('fee_insurance').value = data.settings.fees.insurance;
                    document.getElementById('fee_other').value = data.settings.fees.other;

                    studentsData = data.students;
                    // å…¼å®¹èˆŠæª”æ¡ˆï¼šå¦‚æœèˆŠæª”æ¡ˆæ²’æœ‰ classNameï¼Œå‰‡çµ¦é è¨­å€¼
                    studentsData.forEach(s => {
                        if(!s.className) s.className = data.settings.className;
                    });

                    let nameListStr = "";
                    studentsData.forEach(s => nameListStr += s.name + "\n");
                    document.getElementById('studentRawInput').value = nameListStr.trim();
                    
                    renderStudentList();
                    generate();
                    alert("è®€å–æˆåŠŸï¼");
                } catch (err) {
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- â˜…â˜…â˜… æ ¸å¿ƒï¼šç”¢ç”Ÿå–®å¼µæ”¶æ“š HTML æ¨¡æ¿ (é€šç”¨å‡½æ•¸) â˜…â˜…â˜… ---
        function getReceiptHtml(student, receiptType) {
            const schoolName = document.getElementById('schoolName').value;
            const termDesc = document.getElementById('termDesc').value; 
            const legalNote = document.getElementById('legalNote').value;
            const totalLabel = document.getElementById('totalLabel').value;
            // å„ªå…ˆä½¿ç”¨å­¸ç”Ÿå€‹åˆ¥ç­ç´šï¼Œè‹¥ç„¡å‰‡ç”¨å…¨åŸŸ
            const className = student.className || document.getElementById('className').value;
            
            // ä½¿ç”¨ getFee å‡½æ•¸ï¼Œæ”¯æ´å€‹åˆ¥å­¸ç”Ÿè¦†å¯«
            const f_tuition = getFee(student, 'fee_tuition');
            const f_misc = getFee(student, 'fee_misc');
            const f_material = getFee(student, 'fee_material');
            const f_activity = getFee(student, 'fee_activity');
            const f_lunch = getFee(student, 'fee_lunch');
            const f_snack = getFee(student, 'fee_snack');
            
            // äº¤é€šè²»ç‡ä¹Ÿè¦èƒ½å€‹åˆ¥è¦†å¯«
            const rate_trans_single = getFee(student, 'fee_trans_single');
            const rate_trans_round = getFee(student, 'fee_trans_round');
            
            const f_extended = getFee(student, 'fee_extended');
            const f_insurance = getFee(student, 'fee_insurance');
            const f_other = getFee(student, 'fee_other');

            let val_trans_single = 0;
            let val_trans_round = 0;

            if (student.trans === 'single') {
                val_trans_single = rate_trans_single;
            } else if (student.trans === 'round') {
                val_trans_round = rate_trans_round;
            }

            const total = f_tuition + f_misc + f_material + f_activity + f_lunch + f_snack + 
                          val_trans_single + val_trans_round + f_extended + f_insurance + f_other;

            let topLabel = "";
            if (receiptType === 'school') {
                topLabel = "ç¬¬ä¸€è¯-ç”±å¹¼å…’åœ’å­˜æŸ¥";
            } else if (receiptType === 'payer') {
                topLabel = "ç¬¬äºŒè¯-ç”±ç¹³è²»äººæ”¶åŸ·";
            }

            return `
            <div class="receipt-container">
                <div style="font-size: 15px; margin-bottom: 2px; font-weight:bold;">${topLabel}</div>
                <table class="receipt-table">
                    <tr>
                        <td colspan="5" class="title-row">${schoolName} ç¹³è²»æ”¶æ“š</td>
                    </tr>
                    <tr style="background-color: #fff;">
                        <td colspan="5">
                            <div class="header-info">
                                <span>å¹¼å…’å§“åï¼š<span style="font-size: 1.3em;">${student.name}</span></span>
                                <span>ç­åˆ¥ï¼š${className}</span>
                                <span>ç¹³è²»æ—¥æœŸï¼š${student.date}</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="5" class="desc-text">${termDesc}</td>
                    </tr>
                    <tr>
                        <td colspan="5" class="desc-text">${legalNote}</td>
                    </tr>
                    
                    <tr class="text-center font-bold" style="background-color: #f9f9f9;">
                        <td class="col-item">æ”¶è²»é …ç›®</td>
                        <td class="col-period">æœŸé–“</td>
                        <td class="col-amount">é‡‘é¡</td>
                        <td class="col-desc">èªªæ˜/æœŸç¨‹</td>
                        <td class="col-note">å‚™è¨»</td>
                    </tr>

                    <tr>
                        <td class="text-center font-bold">å­¸è²»</td>
                        <td class="text-center">ä¸€å­¸æœŸ</td>
                        <td class="text-right font-bold">${formatMoney(f_tuition)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">é›œè²»</td>
                        <td class="text-center">ä¸€å€‹æœˆ</td>
                        <td class="text-right font-bold">${formatMoney(f_misc)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">ææ–™è²»</td>
                        <td class="text-center">ä¸€å­¸æœŸ</td>
                        <td class="text-right font-bold">${formatMoney(f_material)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">æ´»å‹•è²»</td>
                        <td class="text-center">ä¸€å€‹æœˆ</td>
                        <td class="text-right font-bold">${formatMoney(f_activity)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">åˆé¤è²»</td>
                        <td class="text-center">ä¸€å€‹æœˆ</td>
                        <td class="text-right font-bold">${formatMoney(f_lunch)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">é»å¿ƒè²»</td>
                        <td class="text-center">ä¸€å€‹æœˆ</td>
                        <td class="text-right font-bold">${formatMoney(f_snack)}</td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td rowspan="2" class="text-center font-bold">äº¤é€šè²»</td>
                        <td class="text-center">å–®è¶Ÿ</td>
                        <td class="text-right font-bold">${formatMoney(val_trans_single)}</td>
                        <td></td>
                        <td rowspan="2" class="small-note">éè£œåŠ©é …ç›®</td>
                    </tr>
                    <tr>
                        <td class="text-center">é›™è¶Ÿ</td>
                        <td class="text-right font-bold">${formatMoney(val_trans_round)}</td>
                        <td></td>
                    </tr>

                    <tr>
                        <td class="text-center font-bold">å»¶é•·ç…§é¡§<br>æœå‹™è²»</td>
                        <td class="text-center">ä¸€å€‹æœˆ</td>
                        <td class="text-right font-bold">${formatMoney(f_extended)}</td>
                        <td></td>
                        <td class="small-note">éè£œåŠ©é …ç›®</td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">ä¿éšªè²»</td>
                        <td class="text-center">ä¸€å­¸æœŸ</td>
                        <td class="text-right font-bold">${formatMoney(f_insurance)}</td>
                        <td class="small-note">ä»¥ç•¶å­¸å¹´åº¦ä¿éšªæ”¶è²»æ¨™æº–è¾¦ç†</td>
                        <td class="small-note">éè£œåŠ©é …ç›®</td>
                    </tr>
                    <tr>
                        <td class="text-center font-bold">å…¶å®ƒ</td>
                        <td></td>
                        <td class="text-right font-bold">${formatMoney(f_other)}</td>
                        <td colspan="2" class="small-note">
                            ä»£è³¼é‹å‹•æœ(åˆ¶æœã€åœå…œ)ã€æ›¸åŒ…åŠé¤å…·ã€æˆ¶å¤–æ•™å­¸é–€ç¥¨ç­‰ã€‚æ‡‰è¦–å®¶é•·å€‹åˆ¥éœ€æ±‚ï¼Œä¸å¾—å¼·åˆ¶è¦æ±‚è³¼è²·æˆ–åƒåŠ ã€‚
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="5" class="total-row">
                            <div style="display:flex; justify-content:center; position:relative;">
                                <span>${totalLabel}</span>
                                <span style="position: absolute; right: 20px;">$${formatMoney(total)}</span>
                            </div>
                        </td>
                    </tr>
                </table>

                <div class="footer-info">
                    <div style="text-align: left;">ç¶“æ‰‹äººï¼š</div>
                    <div style="text-align: center;">åœ’é•·/è² è²¬äººï¼š</div>
                    <div></div> 
                </div>
            </div>
            `;
        }

        function generate() {
            const outputArea = document.getElementById('outputArea');
            let fullHtml = "";
            studentsData.forEach(student => {
                if (!student.name) return;
                fullHtml += getReceiptHtml(student, currentViewMode);
            });
            outputArea.innerHTML = fullHtml;
        }

        function printCombined() {
            const outputArea = document.getElementById('outputArea');
            const originalHtml = outputArea.innerHTML;
            let combinedHtml = "";
            studentsData.forEach(student => {
                if (!student.name) return;
                combinedHtml += getReceiptHtml(student, 'school');
                combinedHtml += getReceiptHtml(student, 'payer');
            });
            outputArea.innerHTML = combinedHtml;
            window.print();
            setTimeout(() => { outputArea.innerHTML = originalHtml; }, 500);
        }
    </script>
</body>
</html>
